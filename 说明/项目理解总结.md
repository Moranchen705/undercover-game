# 谁是卧底游戏 - 项目理解总结

## 一、项目整体架构

### 角色分工
- **主持方（1个组）**：已实现 ✅
  - 平台构建（服务端 + 可视化界面）
  - 流程控制（游戏初始化、轮次推进、结果判定）
  - 通信管理（多客户端并发处理）

- **游戏方（5个组）**：**你们小组负责这部分** ⚠️
  - 客户端开发
  - 游戏策略实现

---

## 二、平台方已实现功能（主持方代码）

### 1. 后端服务器 (backend.py)
**端口**：5000  
**功能**：
- ✅ 游戏方注册接口 `/api/register`
- ✅ 游戏开始接口 `/api/game/start`（主持方专用）
- ✅ 开始回合接口 `/api/game/round/start`（主持方专用）
- ✅ 描述提交接口 `/api/describe`
- ✅ 投票提交接口 `/api/vote`
- ✅ 处理投票结果 `/api/game/voting/process`（主持方专用）
- ✅ 获取游戏状态 `/api/game/state`（主持方专用）
- ✅ 获取公开状态 `/api/status`（游戏方可调用）
- ✅ 获取词语接口 `/api/word`
- ✅ 获取投票结果 `/api/result`
- ✅ 异常上报接口 `/api/report`
- ✅ 获取所有组 `/api/groups`
- ✅ 重置游戏 `/api/game/reset`（主持方专用）

**安全机制**：
- 使用 `X-Admin-Token` 保护主持方接口
- 使用线程锁保证并发安全

### 2. 前端界面 (frontend.py)
**端口**：5001  
**功能**：
- ✅ 可视化游戏管理界面
- ✅ 实时显示游戏状态（每2秒自动刷新）
- ✅ 组名列表展示（区分卧底/平民/已淘汰）
- ✅ 描述展示（带时间戳）
- ✅ 投票结果统计
- ✅ 异常上报记录
- ✅ 得分展示

### 3. 游戏逻辑核心 (game_logic.py)
**功能**：
- ✅ 游戏状态管理（8种状态：WAITING → REGISTERED → WORD_ASSIGNED → DESCRIBING → VOTING → ROUND_END → GAME_END）
- ✅ 组注册管理（最多5组）
- ✅ 随机分配卧底身份
- ✅ 随机排序描述顺序
- ✅ 投票结果判定（完全符合题目要求的a/b/c三种情况）
- ⚠️ 得分计算（需要更新：卧底得分=胜利分+生存分，平民得分=生存分之和）
- ✅ 异常上报记录

### 4. 测试客户端 (test_client.py)
**功能**：
- ✅ 完整的API测试流程
- ✅ 模拟游戏方行为

---

## 三、游戏方需要实现的功能（你们小组的任务）

### 核心要求（来自期末作业选题.md）

#### 1. 客户端开发
- [ ] **组名注册**：通过 `/api/register` 注册唯一组名
- [ ] **词语接收**：通过 `/api/word?group_name=xxx` 获取自己的词语
- [ ] **描述提交**：
  - 在描述阶段通过 `/api/describe` 提交描述
  - **关键限制**：描述提交需在 **≤3秒** 内完成（题目要求）
  - 描述需贴合词语又具迷惑性
- [ ] **投票参与**：
  - 在投票阶段通过 `/api/vote` 提交投票
  - 只能投票给存活组（不能投自己）

#### 2. 游戏策略实现
- [ ] 根据收到的词语（平民词或卧底词）生成合适的描述
- [ ] 通过观察他人描述和投票执行游戏策略
- [ ] 如果被选为卧底，需要隐藏身份并存活到最后

#### 3. 交互逻辑
- [ ] **状态轮询**：通过 `/api/status` 获取游戏阶段状态
  - 轮询频率建议：2~3秒一次（不超过1次/3秒）
  - 根据状态判断当前应该做什么（等待/描述/投票）
- [ ] **时间管理**：
  - 描述提交：45秒内完成（协议文档要求）
  - 投票提交：30秒内完成（协议文档要求）
  - **注意**：题目要求描述间隔≤3秒，但协议文档是45秒，需要确认实际要求
- [ ] **异常处理**：通过 `/api/report` 上报异常情况

### 技术实现要点

#### 1. GUI开发（题目要求）
- 使用 Tkinter、PyQt 等框架
- 界面需包含：
  - ✅ 词语接收展示区
  - ✅ 描述输入与提交按钮
  - ✅ 投票选择列表与提交按钮
  - ✅ **时间限制提示**（确保描述提交≤3秒）

#### 2. 网络通信
- 使用 HTTP 请求与主持方服务器通信
- 处理网络异常和重连
- 实现状态轮询机制

#### 3. 核心逻辑
- 输入校验（描述非空、投票对象为存活组）
- 时间限制检查（描述提交时间）
- 游戏策略算法（生成描述、投票决策）

---

## 四、游戏流程详解

### 完整流程步骤

1. **注册阶段**
   - 游戏方调用 `/api/register` 注册组名
   - 主持方在前端看到所有注册的组

2. **游戏开始**
   - 主持方在前端输入卧底词和平民词，点击"开始游戏"
   - 系统随机选择1个组为卧底，其余为平民
   - 游戏方调用 `/api/word` 获取自己的词语

3. **描述阶段**
   - 主持方点击"开始新回合"
   - 系统随机排序，确定描述顺序
   - 游戏方通过 `/api/status` 轮询，发现状态变为 `describing`
   - 游戏方按顺序提交描述（需在3秒内）
   - 所有组提交后，状态自动变为 `voting`

4. **投票阶段**
   - 游戏方通过 `/api/status` 发现状态变为 `voting`
   - 游戏方提交投票（只能投存活组，不能投自己）
   - 所有组投票后，主持方点击"处理投票结果"

5. **结果判定**
   - 系统根据投票规则判定：
     - **情况a**：得票最多1组 → 淘汰该组
       - 若为卧底 → 游戏结束，平民胜
       - 若为平民 → 检查剩余平民，不足则卧底胜，否则继续
     - **情况b**：得票最多3组 → 
       - 若均为平民 → 3组都淘汰，游戏结束，卧底胜
     - **情况c**：得票最多2组 → 进入下一轮（返回步骤3）
   - 游戏方通过 `/api/result` 获取投票结果

6. **重复流程**
   - 如果游戏未结束，返回步骤3，开始新回合

7. **得分计算**
   - 游戏结束时，系统计算得分：
     - **卧底得分**：
       - 胜利分：平民仅剩1组时得3分
       - 生存分：每生存一轮得1分
       - **最终得分 = 胜利分 + 生存分**（求和）
     - **平民得分**：
       - 生存分：每生存一轮得1分
       - **最终得分 = 该次游戏中的生存分之和**

---

## 五、API接口详细说明（游戏方需要使用的接口）

### 1. 注册组名
```http
POST /api/register
Content-Type: application/json

{
  "group_name": "你们的组名"
}

响应：
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "group_name": "你们的组名",
    "total_groups": 3
  }
}
```

### 2. 获取词语
```http
GET /api/word?group_name=你们的组名

响应：
{
  "code": 200,
  "message": "ok",
  "data": {
    "word": "苹果"  // 或 "梨"（如果是卧底）
  }
}
```

### 3. 获取阶段状态（重要！需要轮询）
```http
GET /api/status

响应：
{
  "code": 200,
  "message": "ok",
  "data": {
    "status": "describing",  // waiting/registered/word_assigned/describing/voting/round_end/game_end
    "round": 2,
    "active_groups": ["组1", "组2", "组3"],
    "describe_order": ["组1", "组2", "组3"],  // 描述顺序
    "eliminated_groups": []  // 已淘汰的组
  }
}
```

**状态说明**：
- `waiting`: 等待注册
- `registered`: 已注册，等待游戏开始
- `word_assigned`: 词语已分配，可以获取词语
- `describing`: 描述阶段，可以提交描述
- `voting`: 投票阶段，可以提交投票
- `round_end`: 回合结束，等待下一回合
- `game_end`: 游戏结束

### 4. 提交描述
```http
POST /api/describe
Content-Type: application/json

{
  "group_name": "你们的组名",
  "description": "这是一个描述"
}

响应：
{
  "code": 200,
  "message": "描述提交成功",
  "data": {
    "round": 2,
    "total_descriptions": 3
  }
}
```

**注意事项**：
- 只能在 `status == "describing"` 时提交
- 只能提交一次
- 需要在3秒内完成（题目要求）

### 5. 提交投票
```http
POST /api/vote
Content-Type: application/json

{
  "voter_group": "你们的组名",
  "target_group": "要投票的组名"
}

响应：
{
  "code": 200,
  "message": "投票提交成功",
  "data": {}
}
```

**注意事项**：
- 只能在 `status == "voting"` 时提交
- 只能投票给 `active_groups` 中的组
- 不能投自己

### 6. 获取投票结果
```http
GET /api/result

响应：
{
  "code": 200,
  "message": "ok",
  "data": {
    "round": 2,
    "vote_count": {
      "组1": 2,
      "组2": 1
    },
    "eliminated": ["组1"],
    "game_ended": false,
    "winner": null  // "undercover" 或 "civilian"
  }
}
```

### 7. 异常上报
```http
POST /api/report
Content-Type: application/json

{
  "group_name": "你们的组名",
  "type": "network",  // 异常类型
  "detail": "描述时断线"
}

响应：
{
  "code": 200,
  "message": "异常已记录",
  "data": {
    "ticket": "RPT-20250101120000-001",
    "recorded_at": "2025-01-01T12:00:00"
  }
}
```

---

## 六、关键注意事项

### 1. 时间限制问题
- **题目要求**：描述提交间隔≤3秒
- **协议文档**：描述提交45秒内完成
- **建议**：实现时以题目要求为准（3秒），但也要考虑实际操作的可行性

### 2. 状态轮询策略
- 建议每2-3秒轮询一次 `/api/status`
- 不要过于频繁（不超过1次/3秒）
- 根据状态自动切换界面和功能

### 3. 错误处理
- 所有API返回的 `code != 200` 时，需要根据 `message` 判断错误原因
- 网络异常时要有重试机制
- 关键操作失败时通过 `/api/report` 上报

### 4. 游戏策略
- 如果是平民：描述要贴合平民词，帮助找出卧底
- 如果是卧底：描述要模糊，避免暴露身份
- 投票时要根据描述内容和投票历史做决策

---

## 七、开发建议（3人小组分工）

### 方案1：按功能模块分工
1. **网络通信负责人**：
   - 实现所有API调用函数
   - 处理网络异常和重连
   - 实现状态轮询机制

2. **GUI开发负责人**：
   - 设计并实现用户界面
   - 实现时间限制提示
   - 实现状态显示和交互

3. **游戏逻辑负责人**：
   - 实现游戏策略算法（描述生成、投票决策）
   - 实现输入校验
   - 实现时间管理

### 方案2：按流程分工
1. **注册和词语获取模块**
2. **描述提交模块**（含时间限制）
3. **投票和结果展示模块**

---

## 八、测试建议

1. **使用 test_client.py 作为参考**
   - 查看 `test_client.py` 了解API调用方式
   - 但需要实现GUI界面，不能只是命令行

2. **与主持方平台联调**
   - 确保能正确连接主持方服务器
   - 测试完整的游戏流程
   - 测试异常情况处理

3. **时间限制测试**
   - 测试描述提交的时间限制功能
   - 确保界面有时间倒计时提示

---

## 九、待确认问题

1. **描述时间限制**：
   - 题目要求间隔≤3秒，协议文档说45秒
   - 需要确认实际要求（题目要求是间隔≤3秒，即每个组描述之间的间隔）

2. **模拟环境**：
   - 平台方未实现自动模拟功能
   - 测试时需要手动运行多个客户端

3. **得分计算**：
   - ⚠️ **需要更新平台方代码**：当前实现是`max(当前回合数, 胜利分3分)`，新规则要求：
     - 卧底得分 = 胜利分 + 生存分（求和）
     - 平民得分 = 生存分之和

4. **游戏次数要求**：
   - 新规则要求：游戏次数应为5的倍数，保证每个游戏组都有相同的次数能够成为卧底
   - 需要确认平台方是否需要实现多局游戏的轮换机制

---

## 总结

**平台方已完成**：
- ✅ 完整的后端API服务
- ✅ 可视化前端界面
- ✅ 游戏逻辑核心（投票判定、得分计算）
- ✅ 多客户端并发支持

**游戏方需要完成**：
- ⚠️ 客户端程序（GUI界面）
- ⚠️ 组名注册功能
- ⚠️ 词语接收和展示
- ⚠️ 描述提交（含3秒时间限制）
- ⚠️ 投票提交
- ⚠️ 状态轮询机制
- ⚠️ 游戏策略实现

**关键挑战**：
- 描述提交的3秒间隔时间限制实现
- 状态轮询和自动流程控制
- 游戏策略算法（如何生成好的描述和投票决策）

**重要更新（2025版规则）**：
- 游戏方数量：4组 → **5组**
- 投票规则变化：情况b改为"得票最多3组"，情况c改为"得票最多2组"
- 得分规则变化：卧底得分改为"胜利分+生存分"（求和），新增平民得分计算
- 游戏次数要求：应为5的倍数，保证每个游戏组都有相同的次数能够成为卧底

